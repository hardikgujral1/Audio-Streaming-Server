<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Audio Sync Streamer</title>
</head>
<body>
  <h2>Sync Audio Stream</h2>
  
  <!-- Display the list of available songs -->
  <div>
    <h3>Available Songs</h3>
    <ul id="songList"></ul>
  </div>

  <br><br>
  <button onclick="sendPlaySignal()">Play for all</button>
  <audio id="audioPlayer" controls></audio>

  <script>
    const ws = new WebSocket(`wss://${location.host}/ws`);
    let currentSong = null;
    let playTime = null;

    ws.onmessage = function(event) {
      const data = JSON.parse(event.data);
      const player = document.getElementById("audioPlayer");

      if (data.event === "load") {
        currentSong = data.song;
        const res = fetch(`/stream/${currentSong}`)
          .then(response => response.json())
          .then(data => {
            player.src = data.stream_url;
            player.pause(); // Load but don't play yet
            console.log("Song loaded, waiting for play signal");
          });
      }

      if (data.event === "play") {
        playTime = data.timestamp;
        console.log("Play signal received at timestamp: " + playTime);
        const delay = playTime - Date.now() / 1000; // Calculate delay in seconds
        setTimeout(() => {
          if (player.src) {
            player.play();
            console.log("Playing song at the correct time");
          }
        }, delay * 1000);
      }
    };

    function sendLoadSong(song) {
      if (ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ event: "load", song }));
      }
    }

    function sendPlaySignal() {
      if (ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ event: "play" }));
      }
    }

    // Fetch available songs
    async function fetchSongList() {
      const response = await fetch("/songs");
      const songList = await response.json();
      const songListContainer = document.getElementById("songList");

      songList.forEach(song => {
        const listItem = document.createElement("li");
        listItem.textContent = song;
        listItem.style.cursor = "pointer";
        listItem.onclick = () => sendLoadSong(song);
        songListContainer.appendChild(listItem);
      });
    }

    window.onload = fetchSongList;
  </script>
</body>
</html>
